import React, { useState } from 'react';
import { 
  CheckCircle2, 
  ChevronRight, 
  Wand2, 
  LayoutGrid,
  TrendingUp,
  BarChart3,
  FileSpreadsheet,
  AlertCircle,
  Zap,
  ShieldCheck,
  PieChart,
  ArrowUpRight,
  Info
} from 'lucide-react';

const App = () => {
  const [view, setView] = useState('cover');
  const [activeTab, setActiveTab] = useState('trial_dump');
  const [stage, setStage] = useState(1);
  const [workflowStep, setWorkflowStep] = useState(0); 
  const [showInsight, setShowInsight] = useState(false);

  const data = {
    trialDump: [
      { particulars: "Revenue from Operations", cy_dr: "", cy_cr: 14800000, py_dr: "", py_cr: 12500000, group: "Income", sub: "Revenue" },
      { particulars: "Cost of Goods Sold", cy_dr: 9600000, cy_cr: "", py_dr: 8200000, py_cr: "", group: "Expense", sub: "COS" },
      { particulars: "Employee Benefits", cy_dr: 1420000, cy_cr: "", py_dr: 1200000, py_cr: "", group: "Expense", sub: "Admin" },
      { particulars: "Depreciation & Amortization", cy_dr: 520000, cy_cr: "", py_dr: 480000, py_cr: "", group: "Expense", sub: "Non-Cash" },
      { particulars: "Finance Costs", cy_dr: 320000, cy_cr: "", py_dr: 280000, py_cr: "", group: "Expense", sub: "Finance" },
      { particulars: "Property, Plant & Equipment", cy_dr: 8450000, cy_cr: "", py_dr: 8450000, py_cr: "", group: "Asset", sub: "Non-Current" },
      { particulars: "Inventory", cy_dr: 2100000, cy_cr: "", py_dr: 1850000, py_cr: "", group: "Asset", sub: "Current" },
      { particulars: "Trade Receivables", cy_dr: 1430000, cy_cr: "", py_dr: 1100000, py_cr: "", group: "Asset", sub: "Current" },
      { particulars: "Cash & Bank", cy_dr: 630000, cy_cr: "", py_dr: 460000, py_cr: "", group: "Asset", sub: "Current" },
      { particulars: "Share Capital", cy_dr: "", cy_cr: 5000000, py_dr: "", py_cr: 5000000, group: "Equity", sub: "Capital" },
      { particulars: "Retained Earnings", cy_dr: "", cy_cr: 3270000, py_dr: "", py_cr: 2660000, group: "Equity", sub: "Reserves" },
      { particulars: "Secured Loans", cy_dr: "", cy_cr: 2500000, py_dr: "", py_cr: 2800000, group: "Liability", sub: "Non-Current" },
      { particulars: "Trade Payables", cy_dr: "", cy_cr: 1840000, py_dr: "", py_cr: 1400000, group: "Liability", sub: "Current" }
    ],
    financials: {
      SOPL: [
        { label: "Revenue from Operations", cy: 14800000, py: 12500000 },
        { label: "Cost of Goods Sold", cy: -9600000, py: -8200000 },
        { label: "Gross Profit", cy: 5200000, py: 4300000, bold: true },
        { label: "Employee Benefits", cy: -1420000, py: -1200000 },
        { label: "Depreciation & Amortization", cy: -520000, py: -480000 },
        { label: "Finance Costs", cy: -320000, py: -280000 },
        { label: "Profit Before Tax", cy: 2940000, py: 2340000, bold: true },
        { label: "Tax Expense (30%)", cy: -882000, py: -702000 },
        { label: "Net Profit for the Year", cy: 2058000, py: 1638000, bold: true }
      ],
      SOFP: [
        { label: "Property, Plant & Equipment", cy: 8450000, py: 8450000 },
        { label: "Inventory", cy: 2100000, py: 1850000 },
        { label: "Trade Receivables", cy: 1430000, py: 1100000 },
        { label: "Cash & Bank", cy: 630000, py: 460000 },
        { label: "Total Assets", cy: 12610000, py: 11860000, bold: true },
        { label: "Share Capital", cy: 5000000, py: 5000000 },
        { label: "Retained Earnings", cy: 3270000, py: 2660000 },
        { label: "Total Equity", cy: 8270000, py: 7660000, bold: true },
        { label: "Secured Loans", cy: 2500000, py: 2800000 },
        { label: "Trade Payables", cy: 1840000, py: 1400000 },
        { label: "Total Liabilities", cy: 4340000, py: 4200000, bold: true },
        { label: "Total Equity & Liabilities", cy: 12610000, py: 11860000, bold: true }
      ],
      SOCF: [
        { label: "Profit Before Tax", cy: 2940000, py: 2340000, bold: true },
        { label: "Adjustments for Non-Cash Items:", cy: null, py: null, italic: true },
        { label: "Add: Depreciation & Amortization", cy: 520000, py: 480000 },
        { label: "Add: Finance Costs", cy: 320000, py: 280000 },
        { label: "Operating Profit before Working Capital Changes", cy: 3780000, py: 3100000, bold: true },
        { label: "Changes in Working Capital:", cy: null, py: null, italic: true },
        { label: "(Increase)/Decrease in Inventory", cy: -250000, py: -200000 },
        { label: "(Increase)/Decrease in Trade Receivables", cy: -330000, py: -300000 },
        { label: "Increase/(Decrease) in Trade Payables", cy: 440000, py: 300000 },
        { label: "Cash Generated from Operations", cy: 3640000, py: 2900000 },
        { label: "Less: Income Tax Paid", cy: -882000, py: -702000 },
        { label: "Net Cash Flow from Operating Activities (A)", cy: 2758000, py: 2198000, bold: true },
        { label: "Net Cash Flow from Investing Activities (B)", cy: 0, py: 0, bold: true },
        { label: "Cash Flow from Financing Activities:", cy: null, py: null, italic: true },
        { label: "Repayment of Secured Loans", cy: -300000, py: -300000 },
        { label: "Interest Paid", cy: -320000, py: -280000 },
        { label: "Dividends Paid / Adjustments", cy: -1968000, py: -1438000 },
        { label: "Net Cash Flow from Financing Activities (C)", cy: -2588000, py: -2018000, bold: true },
        { label: "Net Increase/(Decrease) in Cash (A+B+C)", cy: 170000, py: 180000, bold: true },
        { label: "Add: Opening Cash & Bank Balance", cy: 460000, py: 280000 },
        { label: "Closing Cash & Bank Balance", cy: 630000, py: 460000, bold: true }
      ]
    },
    ratios: {
      currentRatio: 2.27,
      gpMargin: "35.1%",
      netMargin: "13.9%",
      debtEquity: 0.52,
      inventoryDays: 122,
      debtorDays: 35
    }
  };

  const handleEnter = () => setView('workbook');
  const handleClean = () => { setWorkflowStep(1); setStage(2); setShowInsight(true); };
  const handleStandardize = () => { setWorkflowStep(2); setStage(3); };
  const handlePrepare = () => {
    setWorkflowStep(3);
    setTimeout(() => { setStage(4); setActiveTab('financials'); }, 800);
  };

  if (view === 'cover') {
    return (
      <div className="h-screen w-full bg-[#fcfcfc] flex flex-col items-center justify-center p-6 text-slate-800">
        <div className="max-w-2xl w-full">
          <h1 className="text-4xl font-light mb-2 tracking-tight">Sanjeev Khanal</h1>
          <p className="text-slate-400 text-sm mb-16 uppercase tracking-[0.3em]">Chartered Accountant (Semi-qualified)</p>
          <div className="space-y-8 mb-20">
            <p className="text-2xl text-slate-600 leading-relaxed font-light">
              This is not a portfolio. <br />
              This is a walkthrough of how a <span className="text-slate-900 font-medium">professional accountant</span> thinks.
            </p>
          </div>
          <button onClick={handleEnter} className="group flex items-center space-x-4 text-base font-medium text-slate-900 border-b-2 border-slate-900 pb-2 hover:text-slate-500 hover:border-slate-300 transition-all">
            <span>Enter workbook</span>
            <ChevronRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen flex flex-col bg-[#f3f2f1] text-[#323130] overflow-hidden font-sans">
      <div className="bg-white border-b border-[#d1d1d1] flex flex-col shrink-0">
        <div className="flex items-center px-4 py-1 space-x-6 text-xs text-slate-600">
          <span className="font-semibold cursor-default">File</span>
          <span className={`font-semibold ${activeTab === 'trial_dump' ? 'text-[#107c41] border-b-2 border-[#107c41]' : ''} pb-1 cursor-pointer`} onClick={() => setActiveTab('trial_dump')}>Workbook</span>
          <div className="flex-grow" />
          <div className="flex items-center space-x-2">
            <div className="w-2 h-2 rounded-full bg-slate-900" />
            <span className="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">Stage {stage}: {getStageName(stage)}</span>
          </div>
        </div>
        <div className="h-10 border-t border-[#f3f2f1] flex items-center px-4 space-x-4 bg-white">
          <div className="w-8 border-r h-full flex items-center justify-center text-slate-300 italic text-sm">fx</div>
          <div className="flex-grow text-xs font-mono text-slate-400">
            {activeTab === 'analysis' ? `=ROUND(Current_Assets/Current_Liabilities, 2)` : 
             activeTab === 'financials' ? `=SUM(Operating, Investing, Financing)` : ""}
          </div>
        </div>
      </div>

      <div className="flex-grow flex overflow-hidden">
        <div className="flex-grow overflow-auto relative bg-[#e1e1e1]">
          {activeTab === 'trial_dump' && (
            <div className="p-0 min-w-max bg-white min-h-full">
              {workflowStep === 0 && (
                <WorkflowAction 
                  onClick={handleClean} 
                  icon={<Wand2 className="w-4 h-4"/>} 
                  text="clean data" 
                  tooltip="Raw ledgers are often noisy. Cleaning removes duplicates and corrects inconsistencies, ensuring we aren't building a report on a broken foundation."
                />
              )}
              {workflowStep === 1 && (
                <WorkflowAction 
                  onClick={handleStandardize} 
                  icon={<LayoutGrid className="w-4 h-4"/>} 
                  text="standardize data" 
                  tooltip="Different businesses use different names for the same thing. Standardization maps unique account heads to universal audit categories for consistency."
                />
              )}
              {workflowStep === 2 && (
                <WorkflowAction 
                  onClick={handlePrepare} 
                  icon={<CheckCircle2 className="w-4 h-4"/>} 
                  text="prepare fs" 
                  sub="generate audited financials" 
                  tooltip="This is the final transformationâ€”aggregating verified entries into the Statement of Financial Position and Profit & Loss, ready for stakeholder review."
                />
              )}

              <div className="p-2 border-b text-[10px] italic text-slate-400 font-mono">
                source: ledger_extract_v2.csv | status: {workflowStep >= 2 ? 'verified' : 'unreviewed'}
              </div>

              <table className="w-full text-[11px] border-collapse">
                <thead>
                  <tr className="bg-[#f8f9fa] text-slate-500 uppercase text-[9px]">
                    <th className="border p-1 w-8">#</th>
                    <th className="border p-1 text-left px-3 min-w-[220px]">Account Particulars</th>
                    <th colSpan="2" className="border p-1 text-center bg-slate-50">Current Year (Closing)</th>
                    <th colSpan="2" className="border p-1 text-center bg-slate-50">Previous Year (Closing)</th>
                    {workflowStep >= 2 && <th colSpan="2" className="border p-1 text-left px-3 text-slate-900">Audit Classification</th>}
                  </tr>
                  <tr className="bg-[#f8f9fa] text-slate-400 text-[8px]">
                    <th className="border p-1"></th><th className="border p-1"></th>
                    <th className="border p-1 text-right px-3">Debit</th><th className="border p-1 text-right px-3">Credit</th>
                    <th className="border p-1 text-right px-3">Debit</th><th className="border p-1 text-right px-3">Credit</th>
                    {workflowStep >= 2 && <><th className="border p-1 px-3">Group</th><th className="border p-1 px-3">Sub-Group</th></>}
                  </tr>
                </thead>
                <tbody>
                  {data.trialDump.map((row, i) => (
                    <tr key={i} className="hover:bg-slate-50 border-b">
                      <td className="border text-center bg-[#f8f9fa] text-slate-400 px-1">{i+1}</td>
                      <td className={`border px-3 py-1.5 ${workflowStep >= 1 ? 'capitalize' : 'lowercase font-mono text-slate-400'}`}>{row.particulars}</td>
                      <td className="border px-3 py-1 text-right font-mono text-slate-900">{formatNum(row.cy_dr, workflowStep)}</td>
                      <td className="border px-3 py-1 text-right font-mono text-slate-900">{formatNum(row.cy_cr, workflowStep)}</td>
                      <td className="border px-3 py-1 text-right font-mono text-slate-500">{formatNum(row.py_dr, workflowStep)}</td>
                      <td className="border px-3 py-1 text-right font-mono text-slate-500">{formatNum(row.py_cr, workflowStep)}</td>
                      {workflowStep >= 2 && (
                        <>
                          <td className="border px-3 py-1 text-slate-900 font-semibold">{row.group}</td>
                          <td className="border px-3 py-1 text-slate-600 italic">{row.sub}</td>
                        </>
                      )}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {activeTab === 'financials' && (
            <div className="p-12 max-w-4xl mx-auto bg-white min-h-full shadow-lg mb-20">
              <header className="mb-12 border-b-8 border-slate-900 pb-4">
                <h1 className="text-3xl font-black uppercase tracking-tighter">Audited Financial Statements</h1>
                <p className="text-xs text-slate-400 mt-2">Comparative Reporting Cycle | Indirect Method Cash Flow</p>
              </header>

              <FinancialTable title="Statement of Profit and Loss" rows={data.financials.SOPL} />
              <FinancialTable title="Statement of Financial Position" rows={data.financials.SOFP} />
              <FinancialTable title="Statement of Cash Flows (Indirect Method)" rows={data.financials.SOCF} />

              <footer className="mt-20 border-t pt-6 text-[10px] text-slate-400 italic text-right flex justify-between items-center">
                <span>Verification ID: #SX-2025-CF-09</span>
                <span>Financial statements describe a business. They do not explain it.</span>
              </footer>

              <div className="flex justify-center mt-12 pb-12">
                <button onClick={() => {setActiveTab('analysis'); setStage(5);}} className="text-xs text-slate-500 flex items-center space-x-2 group hover:text-slate-900 transition-all">
                  <span className="border-b border-transparent group-hover:border-slate-900 uppercase font-bold tracking-tighter">view ratio analysis</span>
                  <ChevronRight className="w-3 h-3 translate-y-0.5" />
                </button>
              </div>
            </div>
          )}

          {activeTab === 'analysis' && (
            <div className="p-12 max-w-5xl mx-auto min-h-full space-y-10">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <RatioBox title="Liquidity" label="Current Ratio" value={data.ratios.currentRatio} note="Target Benchmark: 1.50x - 2.00x" />
                <RatioBox title="Profitability" label="GP Margin" value={data.ratios.gpMargin} note="Core operational surplus" />
                <RatioBox title="Solvency" label="Debt/Equity" value={data.ratios.debtEquity} note="Capital structure health" />
              </div>
              
              <div className="bg-white border-2 border-slate-900 p-10 shadow-sm relative overflow-hidden group">
                <h3 className="text-xs font-bold uppercase text-slate-400 tracking-widest flex items-center mb-8 relative">
                  <TrendingUp className="w-4 h-4 mr-2 text-slate-900" /> Efficiency Cycle Insights
                </h3>
                <div className="grid grid-cols-2 gap-16 relative">
                  <div>
                    <div className="text-4xl font-light text-slate-900">{data.ratios.inventoryDays} <span className="text-sm font-medium text-slate-400">Days</span></div>
                    <div className="text-[10px] text-slate-500 uppercase mt-2 tracking-tighter">Inventory Holding (Stock velocity)</div>
                  </div>
                  <div>
                    <div className="text-4xl font-light text-slate-900">{data.ratios.debtorDays} <span className="text-sm font-medium text-slate-400">Days</span></div>
                    <div className="text-[10px] text-slate-500 uppercase mt-2 tracking-tighter">Debtor Collection (Receivable cycle)</div>
                  </div>
                </div>
              </div>

              <div className="flex justify-center mt-12">
                <button onClick={() => {setActiveTab('professional_insights'); setStage(6);}} className="text-xs text-slate-500 flex items-center space-x-2 group hover:text-slate-900">
                  <span className="border-b border-transparent group-hover:border-slate-900 uppercase font-bold tracking-tighter">view professional insights</span>
                  <ChevronRight className="w-3 h-3 translate-y-0.5" />
                </button>
              </div>
            </div>
          )}

          {activeTab === 'professional_insights' && (
            <div className="p-12 max-w-5xl mx-auto min-h-full pb-32 space-y-8">
               <div className="bg-slate-900 text-white p-12 space-y-4 shadow-2xl relative">
                  <h3 className="text-[10px] font-bold uppercase text-slate-500 tracking-[0.2em]">Audit Summary & Synthesis</h3>
                  <p className="text-2xl font-light leading-relaxed max-w-2xl relative z-10">
                    The <span className="text-white border-b border-slate-500 font-medium">Indirect Cash Flow reconciliation</span> indicates a robust conversion of Profit Before Tax to Operating Cash, though significant dividends suggest a capital-heavy distribution phase.
                  </p>
               </div>

               <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <InsightCard title="Revenue Quality" icon={<ArrowUpRight className="w-4 h-4" />}>
                    Growth of 18.4% YoY is supported by a healthy 35.1% GP margin. However, the rise in Trade Receivables (30% increase) outpaces revenue growth, suggesting a potential relaxation in credit terms or collection friction.
                  </InsightCard>
                  
                  <InsightCard title="Working Capital Drag" icon={<Zap className="w-4 h-4" />}>
                    Inventory holding at 122 days represents a significant liquidity lock-up. This "Inventory Trap" is the primary reason why net cash increase (170k) is substantially lower than net profit (2.05M).
                  </InsightCard>

                  <InsightCard title="Capital Structure" icon={<ShieldCheck className="w-4 h-4" />}>
                    Debt-to-Equity remains conservative at 0.52. The reduction in Secured Loans (-300k) alongside healthy interest coverage indicates strong solvency and low financial risk.
                  </InsightCard>

                  <InsightCard title="Cash Flow Quality" icon={<BarChart3 className="w-4 h-4" />}>
                    Cash conversion cycle is currently 122 + 35 - 70 (estimated) = 87 days. The reliance on Trade Payables to fund inventory (Increase of 440k) is a short-term strategy that may hit limits.
                  </InsightCard>

                  <InsightCard title="Tax & Compliance" icon={<AlertCircle className="w-4 h-4" />}>
                    Effective tax rate is aligned at 30%. Non-cash add-backs (Depreciation & Finance costs) provide a 840k buffer to operating cash flow, acting as a natural internal hedge against inflation.
                  </InsightCard>

                  <InsightCard title="Strategic Outlook" icon={<PieChart className="w-4 h-4" />}>
                    The high dividend payout (approx. 95% of net profit) suggests the entity is in a 'Mature/Cash Cow' phase, opting for shareholder returns over aggressive reinvestment in PPE.
                  </InsightCard>
               </div>

               <div className="pt-16 text-center border-t border-slate-200">
                  <p className="text-sm italic text-slate-400 mb-10 max-w-lg mx-auto">"A Balance Sheet is a snapshot; the Cash Flow is the movie. Integrity lies in ensuring they tell the same story."</p>
                  <div className="flex justify-center space-x-6">
                    <button className="px-8 py-3 bg-slate-900 text-white text-[10px] font-bold uppercase tracking-widest hover:bg-slate-700 transition-all shadow-lg">Download CV</button>
                    <button className="px-8 py-3 border-2 border-slate-900 text-slate-900 text-[10px] font-bold uppercase tracking-widest hover:bg-slate-50 transition-all">Contact Me</button>
                  </div>
               </div>
            </div>
          )}
        </div>

        {showInsight && (
          <div className="w-72 bg-white border-l p-8 shrink-0 hidden lg:block animate-in slide-in-from-right duration-500">
            <h4 className="text-[10px] font-black uppercase text-slate-300 mb-8 tracking-[0.3em]">Context</h4>
            <p className="text-xs leading-relaxed text-slate-500 font-light italic">
              {getInsightText(stage)}
            </p>
          </div>
        )}
      </div>

      <div className="bg-[#f3f2f1] border-t border-[#d1d1d1] flex items-center px-2 py-0.5 text-[10px] shrink-0 font-medium">
        <div className="flex space-x-0.5">
          <SheetTab name="trial_dump" active={activeTab === 'trial_dump'} onClick={() => setActiveTab('trial_dump')} />
          <SheetTab name="financials" active={activeTab === 'financials'} onClick={() => workflowStep === 3 && setActiveTab('financials')} disabled={workflowStep < 3} />
          <SheetTab name="analysis" active={activeTab === 'analysis'} onClick={() => workflowStep === 3 && setActiveTab('analysis')} disabled={workflowStep < 3} />
          <SheetTab name="professional_insights" active={activeTab === 'professional_insights'} onClick={() => workflowStep === 3 && setActiveTab('professional_insights')} disabled={workflowStep < 3} />
        </div>
      </div>
    </div>
  );
};

const WorkflowAction = ({ onClick, icon, text, sub, tooltip }) => (
  <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 flex flex-col items-center group">
    <button 
      onClick={onClick} 
      className="bg-white border-2 border-slate-900 shadow-[20px_20px_0px_rgba(0,0,0,0.05)] px-10 py-6 flex flex-col items-center space-y-3 hover:bg-slate-50 transition-all rounded-sm"
    >
      <div className="flex items-center space-x-4 text-slate-900 group-hover:scale-105 transition-transform">
        {icon} <span className="text-sm font-black uppercase tracking-widest">{text}</span>
      </div>
      {sub && <span className="text-[10px] text-slate-400 font-medium lowercase tracking-tight">{sub}</span>}
    </button>
    <div className="mt-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none max-w-xs text-center bg-slate-900 text-white p-4 text-[11px] leading-relaxed rounded-md shadow-2xl relative">
      <p className="font-light italic text-slate-300">
        {tooltip}
      </p>
      <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-900 rotate-45"></div>
    </div>
  </div>
);

const SheetTab = ({ name, active, onClick, disabled }) => (
  <button onClick={onClick} disabled={disabled} className={`px-6 py-1.5 border-r border-[#d1d1d1] transition-all min-w-[120px] uppercase tracking-tighter text-center
    ${active ? 'bg-white text-[#107c41] border-t-2 border-t-[#107c41] font-black' : 'bg-[#e1e1e1] text-slate-500 hover:bg-[#d5d5d5]'}
    ${disabled ? 'opacity-30 cursor-not-allowed' : 'cursor-pointer'}`}>
    {name.replace('_', ' ')}
  </button>
);

const FinancialTable = ({ title, rows }) => (
  <section className="mb-14">
    <h2 className="text-[10px] font-black bg-slate-900 text-white px-3 py-1 mb-4 inline-block uppercase tracking-[0.2em]">{title}</h2>
    <table className="w-full text-sm">
      <thead>
        <tr className="text-[9px] text-slate-400 uppercase text-right border-b">
          <th className="text-left font-bold pb-2 text-slate-500">Particulars</th>
          <th className="pb-2">Current Year</th>
          <th className="pb-2">Previous Year</th>
        </tr>
      </thead>
      <tbody>
        {rows.map((r, i) => (
          <tr key={i} className={`border-b border-slate-50 hover:bg-slate-50/50 transition-colors ${r.bold ? 'font-bold border-t border-slate-400' : ''} ${r.italic ? 'italic text-slate-400 bg-slate-50/20' : ''}`}>
            <td className={`py-3 pr-4 ${r.bold ? 'text-slate-900' : 'text-slate-600'} ${r.italic ? 'pl-2' : ''}`}>{r.label}</td>
            <td className={`text-right py-3 font-mono ${r.bold ? 'text-slate-900' : 'text-slate-800'}`}>{r.cy !== null ? formatValue(r.cy) : ''}</td>
            <td className="text-right py-3 font-mono text-slate-400">{r.py !== null ? formatValue(r.py) : ''}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </section>
);

const RatioBox = ({ title, label, value, note }) => (
  <div className="bg-white border-2 border-slate-200 p-8 shadow-sm hover:border-slate-900 transition-all group">
    <div className="text-[10px] font-black text-slate-900 uppercase mb-4 tracking-widest border-b border-slate-900 inline-block pb-1">{title}</div>
    <div className="text-4xl font-light text-slate-900 mb-1 group-hover:scale-105 transition-transform origin-left">{value}</div>
    <div className="text-xs font-bold text-slate-500 mb-6">{label}</div>
    <p className="text-[10px] leading-relaxed text-slate-400 italic font-medium">{note}</p>
  </div>
);

const InsightCard = ({ title, icon, children }) => (
  <div className={`bg-white border-l-8 border-slate-900 p-8 shadow-sm space-y-4 hover:shadow-md transition-shadow group`}>
    <div className="flex items-center space-x-3 text-slate-900 text-xs font-black uppercase tracking-widest group-hover:translate-x-1 transition-transform">
      {icon} <span>{title}</span>
    </div>
    <p className="text-sm leading-relaxed text-slate-600 font-light italic">
      {children}
    </p>
  </div>
);

const formatValue = (num) => {
  if (num === undefined || num === null) return "-";
  const abs = Math.abs(num);
  const formatted = abs.toLocaleString();
  return num < 0 ? `(${formatted})` : formatted;
};

const formatNum = (val, step) => {
  if (val === "" || val === undefined) return "";
  if (step === 0) return val;
  return Number(val).toLocaleString();
};

const getStageName = (s) => ['', 'Ingestion', 'Integrity', 'Structure', 'Presentation', 'Analytical Review', 'Opinion'][s];

const getInsightText = (s) => {
  switch(s) {
    case 2: return "Reconciling profit to cash flow is where 'accounting profit' meets 'economic reality'.";
    case 4: return "The indirect method allows us to identify why cash didn't grow as fast as profits (Working Capital traps).";
    default: return "Verification of the opening/closing cash balances ensures the entire ledger is mathematically sound.";
  }
};

export default App;
