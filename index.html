<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanjeev Khanal - Financial Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 224 71.4% 4.1%;
            --primary: 217 91% 60%;
            --primary-foreground: 210 20% 98%;
            --secondary: 220 14.3% 95.9%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 220 14.3% 95.9%;
            --muted-foreground: 220 8.9% 46.1%;
            --border: 220 13% 91%;
            --input: 220 13% 91%;
            --radius: 0.5rem;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 14px;
            line-height: 1.5;
        }

        @keyframes pulse-slow {
          '0%, 100%' { opacity: '0.2'; transform: 'scale(1)' }
          '50%' { opacity: '0.4', transform: 'scale(1.05)' }
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        #cover-view {
            position: relative;
            min-height: 100vh;
            width: 100%;
            overflow: hidden;
            background-color: #f8fafc;
            color: #1e293b;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        #cover-view.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #engine-view {
            display: none; /* Initially hidden */
            opacity: 0;
            transition: opacity 0.8s ease-out 0.3s;
        }
        
        #engine-view.visible {
            display: flex;
            opacity: 1;
        }

        .cover-bg {
            position: absolute;
            inset: 0;
            z-index: -10;
        }
        .cover-bg-gradient {
            position: absolute;
            inset: 0;
            background-image: radial-gradient(circle at center, rgba(60,120,255,0.08), transparent 40%);
        }
        .cover-bg-blur-1 {
            position: absolute;
            top: -25%;
            right: -25%;
            width: 75%;
            height: 75%;
            background-color: rgba(59, 130, 246, 0.2);
            border-radius: 9999px;
            filter: blur(120px);
            opacity: 0.2;
            animation: pulse-slow 8s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .cover-bg-blur-2 {
            position: absolute;
            bottom: -25%;
            left: -25%;
            width: 66.66%;
            height: 66.66%;
            background-color: rgba(6, 182, 212, 0.2);
            border-radius: 9999px;
            filter: blur(120px);
            opacity: 0.2;
            animation: pulse-slow 10s 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .cover-main {
            position: relative;
            z-index: 10;
            display: grid;
            width: 100%;
            max-width: 1024px;
            grid-template-columns: 1fr;
            gap: 3rem;
            text-align: center;
        }

        .cover-identity {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .cover-identity h1 {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: #0f172a;
        }
        .cover-identity p {
            margin-top: 1rem;
            font-size: 1.125rem;
            color: #475569;
        }
        .cover-identity-links {
            margin-top: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
        }
        .cover-identity-links a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
        }
        .cover-identity-links a:hover {
            color: hsl(var(--primary));
        }

        .cover-cta {
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-top: 2px solid #e2e8f0;
            padding-top: 2rem;
        }

        .cover-cta h2 {
            font-size: 2.25rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            color: #0f172a;
        }

        .cover-cta p {
            margin-top: 1.5rem;
            max-width: 42rem;
            font-size: 1.125rem;
            color: #475569;
        }

        .cover-cta .explore-button {
            margin-top: 2.5rem;
        }

        .explore-button-inner {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            background-color: hsl(var(--primary));
            padding: 1rem 2rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: white;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            transform: translateY(0);
        }

        .explore-button-inner:hover {
            background-color: hsl(var(--primary) / 0.9);
            box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.3);
            transform: translateY(-4px);
        }
        .explore-button-inner svg {
            margin-left: 0.75rem;
            transition: transform 0.3s;
        }
        .explore-button-inner:hover svg {
            transform: translateX(6px);
        }

        /* Engine View */
        .engine-container {
            min-height: 100vh;
            width: 100%;
            background-color: #f8fafc;
            color: hsl(var(--foreground));
            display: flex;
            flex-direction: column;
        }

        .engine-header {
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            background-color: white;
            border-bottom: 1px solid hsl(var(--border));
            z-index: 20;
        }
        .engine-header h1 {
            font-weight: 700;
            font-size: 1.25rem;
        }
        .engine-header-dots {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .engine-header-dots .dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 9999px;
            transition: background-color 0.3s;
            background-color: hsl(var(--border));
        }
        .engine-header-dots .dot.active {
            background-color: hsl(var(--primary));
        }

        .engine-main {
            flex-grow: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .engine-visual-container {
            order: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: hsl(var(--secondary) / 0.8);
        }
        .engine-controls-container {
            order: 2;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        
        .machine-visual-outer {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .machine-visual-inner {
            width: 100%;
            max-width: 576px;
            height: 60vh;
            flex: none;
        }

        .shell-empty-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .shell-empty-box {
            width: 60vh;
            height: 100%;
            position: relative;
        }

        .shell-empty-main {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .shell-empty-shadow {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.05);
            border-radius: 0.75rem;
            z-index: -10;
            transform: skew(-4deg, -2deg);
        }
        .shell-empty-text {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }
        .shell-empty-text h2 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .machine-active-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .balance-sheet-container {
            width: 100%;
            display: flex;
            align-items: stretch;
            justify-content: center;
            padding: 1rem;
            gap: 1rem;
            height: 100%;
        }
        .balance-sheet-col {
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .balance-sheet-blocks {
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: hsl(var(--muted) / 0.3);
            border-radius: 0.375rem;
            padding: 0.25rem;
            gap: 0.25rem;
            border: 1px solid hsl(var(--border));
            position: relative;
        }
        .balance-sheet-block {
            border-radius: 0.25rem;
            padding: 0.25rem;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: height 0.5s ease-out;
            overflow: hidden;
        }
        .bs-block-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .bs-block-content-small {
            flex-direction: row;
            gap: 0.5rem;
        }
        .bs-block-label { font-weight: 700; font-size: 0.875rem; }
        .bs-block-value { font-size: 0.75rem; font-family: monospace; }
        .bs-block-content-small .bs-block-label { font-size: 10px; white-space: nowrap; }
        .bs-block-content-small .bs-block-value { font-size: 10px; white-space: nowrap; }

        .balance-sheet-total {
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: hsl(var(--muted-foreground));
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0.25rem;
            height: 2.5rem;
        }
        .balance-sheet-total span:last-child {
            font-family: monospace;
            white-space: nowrap;
        }

        .revenue-container {
            width: 100%;
            max-width: 576px;
            margin-top: 0.5rem;
        }
        .revenue-bar-outer {
            width: 100%;
            padding: 1rem;
        }
        .revenue-bar-label {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: hsl(var(--muted-foreground));
            margin-bottom: 0.25rem;
        }
        .revenue-bar-wrapper {
            height: 4rem;
            width: 100%;
            background-color: hsl(var(--muted) / 0.3);
            border-radius: 0.375rem;
            padding: 0.25rem;
            border: 1px solid hsl(var(--border));
            position: relative;
            overflow: hidden;
        }
        .revenue-bar-inner {
            height: 100%;
            background-color: hsla(142, 76%, 56%, 0.8);
            border-radius: 0.125rem;
            transition: width 0.5s ease-out;
        }
        .revenue-bar-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
            color: #0f172a;
            font-size: 1.125rem;
        }

        .running-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: hsla(222, 47%, 11%, 0.2);
        }

        .running-icon-wrapper {
            animation: spin 2s linear infinite;
        }

        .controls-content {
            width: 100%;
            max-width: 448px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .controls-inner {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chapter-title {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .chapter-description {
            color: hsl(var(--muted-foreground));
            font-size: 1.125rem;
            margin-bottom: 2rem;
            text-align: justify;
        }

        .chapter-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            width: 100%;
            max-width: 448px;
            margin-top: auto;
            padding-top: 2rem;
        }

        .chapter-form-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            font-size: 0.875rem;
            text-align: left;
            width: 100%;
            max-width: 384px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .form-label {
            font-weight: 500;
            color: #334155;
        }
        .input {
            display: flex;
            height: 2.5rem;
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid hsl(var(--primary) / 0.3);
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
        }
        .input::placeholder {
            color: hsl(var(--muted-foreground));
        }
        .input:focus {
            outline: none;
            box-shadow: 0 0 0 2px hsl(var(--background)), 0 0 0 4px hsl(var(--ring));
        }
        .input[readonly] {
            background-color: #f1f5f9;
        }
        .input-sm {
            height: 2rem;
            font-size: 0.875rem;
        }
        .font-mono { font-family: monospace; }
        .text-right { text-align: right; }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: hsl(var(--secondary));
            border-radius: 9999px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .slider:hover {
            opacity: 1;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: hsl(var(--background));
            border: 2px solid hsl(var(--primary));
            border-radius: 50%;
            cursor: pointer;
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
            padding: 0.5rem 1rem;
        }
        .button.primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            box-shadow: 0 4px 6px -1px hsl(var(--primary) / 0.2), 0 2px 4px -1px hsl(var(--primary) / 0.1);
        }
        .button.primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        .button.ghost {
            background-color: transparent;
        }
        .button.ghost:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        .button:disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        .button-sm {
            padding: 0.25rem 0.75rem;
            height: 2rem;
        }
        .button-icon-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .final-screen {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background-color: hsl(var(--background));
            text-align: center;
        }

        .final-screen h2 {
            font-size: 2.25rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        .final-screen p {
            margin-top: 2rem;
            font-size: 1.125rem;
            color: hsl(var(--muted-foreground));
        }
        .final-screen .button-group {
            margin-top: 2.5rem;
        }
        
        .hidden { display: none !important; }

        @media (min-width: 768px) {
            .cover-main {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                text-align: left;
                gap: 3rem;
            }
            .cover-identity {
                align-items: flex-start;
            }
             .cover-identity h1 {
                font-size: 3.75rem;
             }
            .cover-identity-links {
                justify-content: flex-start;
            }
            .cover-cta {
                border-top: none;
                border-left: 2px solid #e2e8f0;
                padding-top: 0;
                padding-left: 3rem;
            }
            .cover-cta h2 {
                font-size: 3rem;
            }

            .engine-main {
                flex-direction: row;
            }
            .engine-visual-container {
                order: 1;
                width: 50%;
                border-right: 1px solid hsl(var(--border));
            }
            .engine-controls-container {
                order: 2;
                width: 50%;
            }
            .chapter-description {
                font-size: 1.125rem;
            }
        }
    </style>
</head>
<body>

    <div id="cover-view">
        <div class="cover-bg">
            <div class="cover-bg-gradient"></div>
            <div class="cover-bg-blur-1"></div>
            <div class="cover-bg-blur-2"></div>
        </div>
        <main class="cover-main">
            <div class="cover-identity">
                <h1>Sanjeev Khanal</h1>
                <p>Semi-Qualified CA</p>
                <div class="cover-identity-links">
                    <a href="mailto:mail@sanjeevkhanal.com.np">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                        <span>Contact Me</span>
                    </a>
                    <a href="https://www.linkedin.com/in/sanjeev-khanal" target="_blank" rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect width="4" height="12" x="2" y="9"/><circle cx="4" cy="4" r="2"/></svg>
                        <span>LinkedIn</span>
                    </a>
                </div>
            </div>
            <div class="cover-cta">
                <h2>Welcome.</h2>
                <p>Finance is a powerful engine that drives our world. Curious to see how it works? Let's explore it together.</p>
                <div class="explore-button">
                    <button id="explore-button" class="explore-button-inner">
                        <span>Explore</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="engine-view" class="engine-container">
        <header class="engine-header">
            <button id="reload-button" style="background:none; border:none; cursor:pointer; text-align:left;">
                <h1 class="font-bold text-xl">Sanjeev Khanal</h1>
            </button>
            <div class="engine-header-dots" id="chapter-dots"></div>
        </header>

        <main id="main-content" class="engine-main">
            <!-- This will be populated by JS -->
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- STATE MANAGEMENT ---
        let chapter = 1;
        let companyName = 'Stark Industries';
        let totalCapital = 1000000;
        let equityPercent = 75;
        let equity = 0;
        let debt = 0;
        let ppe = 0;
        let workingCapital = 0;
        let assetTurnover = 2;
        let cogsPercent = 60;
        let opex = '';
        let interest = '';
        let taxPercent = 25;
        let dividendPercent = 50;

        let payments = {
            cogs: { paid: false },
            opex: { paid: false },
            interest: { paid: false },
            tax: { paid: false },
        };
        let remainingRevenue = 0;
        
        const chapters = [
            { name: "The Shell", description: "Every great enterprise begins as a simple idea, a legal 'shell.' It has a name and a purpose, but it is an empty vessel. It has no assets, no employees, and no capital. It is pure potential, waiting for the fuel it needs to start its engine. Let's give our company a name to begin." },
            { name: "The Fuel", description: "A company needs fuel to operate. This fuel is Capital, the money used to purchase assets and fund operations. It comes from two primary sources, Equity which is cash invested by the owners, and Debt which is cash borrowed from lenders. This mix, known as the Capital Structure, is a crucial decision that will define the company's risk and potential returns." },
            { name: "The Conversion", description: "The fuel is in the tank. The capital you have raised, a total of <strong>{capital}</strong>, is now cash in the company's bank account. This is the most basic form of an asset. But cash itself does not generate returns, it must be converted into productive assets. The balance sheet is born. On one side, what the company owns (Assets), and on the other, who has a claim to those assets (Equity and Liabilities)." },
            { name: "The Deployment", description: "Cash must be put to work. A portion is used to acquire Fixed Assets, also called Property, Plant, and Equipment, which are the long term tools the business will use to create its products or services. The remainder is kept as Working Capital, the lifeblood for day to day operations like paying salaries and buying inventory. This allocation is a critical trade off between long term investment and short term liquidity." },
            { name: "The Output", description: "The machine is now running. Assets are working to generate Revenue, the total sales earned from customers. The efficiency of this process is measured by Asset Turnover (Revenue รท Assets). A higher turnover means the company is squeezing more sales from every rupee invested in its assets. This ratio is a powerful indicator of operational performance." },
            { name: "The Reality", description: "Revenue is not profit, it is simply the starting point. The cash generated from sales does not belong to the company yet, it is first claimed by all the parties who helped generate it. This is the reality of business. Before owners can claim their share, the costs of running the machine must be paid. This process of distribution is what the Income Statement is all about." },
            { name: "The Distribution", description: "The revenue must now be distributed. First, we pay the direct costs of production (Cost of Goods Sold). Then come the overheads, like marketing and administrative salaries (Operating Expenses). Next, lenders must be paid their Interest on the debt we took. Finally, the government takes its share in the form of Taxes. What remains after this cascade of payments is the Net Profit." },
            { name: "The Compounding", description: "The Net Profit is what's left for the owners. They face a choice, withdraw the cash as Dividends for their personal use, or reinvest it back into the business as Retained Earnings. Reinvesting the profits increases the company's equity base, giving it more capital to grow in the next cycle. This is the engine of compounding, where profits from one period fuel the growth of the next." },
            { name: "The Engine of Value", description: "The cycle is complete. By reinvesting the profits, the company's equity has grown, making it more valuable. This is the fundamental engine of finance, capital is deployed to create assets, assets generate profit, and a portion of that profit is retained to increase the capital base. The machine gets bigger and more powerful with every turn. You have just built the engine of value creation." },
        ];

        // --- DOM ELEMENTS ---
        const coverView = document.getElementById('cover-view');
        const engineView = document.getElementById('engine-view');
        const mainContent = document.getElementById('main-content');
        const chapterDotsContainer = document.getElementById('chapter-dots');
        
        // --- HELPERS ---
        const formatCurrency = (value) => {
            if (Math.abs(value) >= 10000000) {
                return 'Rs ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 }).format(value / 10000000) + ' Cr';
            }
            if (Math.abs(value) >= 100000) {
                return 'Rs ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 }).format(value / 100000) + ' Lakhs';
            }
            return 'Rs ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(value);
        };

        const getNumericValue = (val) => (val === '' || isNaN(val)) ? 0 : Number(val);
        
        // --- CORE LOGIC ---
        const calculateFinancials = () => {
            const debtPercent = 100 - equityPercent;
            const capital = equity + debt;
            const revenue = capital * getNumericValue(assetTurnover);
            const cogs = revenue > 0 ? revenue * (getNumericValue(cogsPercent) / 100) : 0;
            const pbt = revenue - cogs - getNumericValue(opex) - getNumericValue(interest);
            const tax = pbt > 0 ? pbt * (getNumericValue(taxPercent) / 100) : 0;
            const netProfit = pbt - tax;
            const dividends = netProfit > 0 ? netProfit * (getNumericValue(dividendPercent) / 100) : 0;
            const retainedEarnings = netProfit - dividends;

            const cashPostAsset = capital - ppe - workingCapital;
            const totalAssetsBS = (chapter < 4) ? capital : ppe + workingCapital + cashPostAsset;
            const totalEquityBS = equity + (chapter >= 9 ? retainedEarnings : 0);
            const totalLiabilitiesBS = debt;
            const totalEquityAndLiabilities = totalEquityBS + totalLiabilitiesBS;

            return { capital, revenue, cogs, pbt, tax, netProfit, dividends, retainedEarnings, cashPostAsset, totalAssetsBS, totalEquityBS, totalLiabilitiesBS, totalEquityAndLiabilities };
        }
        
        const render = () => {
            // Update Chapter Dots
            chapterDotsContainer.innerHTML = chapters.map((_, i) => 
                `<div class="dot ${chapter > i ? 'active' : ''}"></div>`
            ).join('');

            if (chapter > 9) {
                mainContent.innerHTML = `
                    <div class="final-screen">
                        <div class="max-w-2xl mx-auto">
                            <h2>This is how money works.</h2>
                            <p>Thank you for taking this journey through the financial engine.</p>
                            <div class="button-group">
                                <button id="back-to-home-btn" class="button primary button-icon-text" style="font-size: 1.125rem; padding: 0.75rem 1.5rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                                    Back to Home
                                </button>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('back-to-home-btn').onclick = () => window.location.reload();
                return;
            }

            const financials = calculateFinancials();
            const { capital, revenue, cogs, pbt, tax, netProfit, dividends, retainedEarnings, cashPostAsset, totalAssetsBS, totalEquityBS, totalEquityAndLiabilities } = financials;
            const currentChapter = chapters[chapter - 1];

            // --- RENDER VISUAL ---
            const renderBalanceSheetBlock = ({label, value, heightPercent, colorClass}) => {
                if (value <= 0 || heightPercent <= 0) return '';
                const formattedValue = formatCurrency(value);
                
                let content;
                 if (heightPercent < 5) {
                    content = '';
                } else if (heightPercent < 15) {
                    content = `<div class="bs-block-content bs-block-content-small"><span class="bs-block-label">${label}</span><span class="bs-block-value">${formattedValue}</span></div>`;
                } else {
                    content = `<div class="bs-block-content"><span class="bs-block-label">${label}</span><span class="bs-block-value">${formattedValue}</span></div>`;
                }

                return `<div class="balance-sheet-block" style="height: ${heightPercent}%; background-color: ${colorClass};">${content}</div>`;
            };

            const ppeForDisplay = ppe;
            const wcForDisplay = workingCapital;
            const cashForDisplay = cashPostAsset + (chapter >= 9 ? retainedEarnings : 0);
            const assetsForDisplay = (chapter < 3) ? capital : (chapter === 3 ? capital : ppeForDisplay + wcForDisplay + cashForDisplay);
            const equityForDisplay = equity + (chapter >= 9 ? retainedEarnings : 0);
            const debtForDisplay = debt;
            const eAndLForDisplay = equityForDisplay + debtForDisplay;

            let visualHTML;
            const hasInjectedCapital = capital > 0;

            if (!hasInjectedCapital || chapter < 2) {
                visualHTML = `
                <div class="shell-empty-container">
                    <div class="shell-empty-box">
                        <div class="shell-empty-main"></div>
                        <div class="shell-empty-shadow"></div>
                        <div class="shell-empty-text">
                            <h2>${companyName.trim() ? companyName : 'YOUR COMPANY'}</h2>
                            <p>Incorporated 2026</p>
                        </div>
                    </div>
                </div>`;
            } else {
                 let assetBlocks = '';
                 if (chapter < 4) {
                    assetBlocks = renderBalanceSheetBlock({label: "Cash", value: capital, heightPercent: 100, colorClass: "hsla(145, 63%, 49%, 0.8)"});
                 } else if (chapter < 9) {
                     assetBlocks = `
                        ${renderBalanceSheetBlock({label: "Fixed Assets (PPE)", value: ppeForDisplay, heightPercent: ppeForDisplay / assetsForDisplay * 100, colorClass: "hsla(204, 86%, 53%, 0.8)"})}
                        ${renderBalanceSheetBlock({label: "Working Capital", value: wcForDisplay, heightPercent: wcForDisplay / assetsForDisplay * 100, colorClass: "hsla(39, 92%, 63%, 0.8)"})}
                        ${renderBalanceSheetBlock({label: "Cash", value: cashForDisplay, heightPercent: cashForDisplay / assetsForDisplay * 100, colorClass: "hsla(145, 63%, 49%, 0.8)"})}
                     `;
                 } else { // chapter 9+
                    assetBlocks = `
                        ${renderBalanceSheetBlock({label: "Fixed Assets (PPE)", value: ppeForDisplay, heightPercent: ppeForDisplay / assetsForDisplay * 100, colorClass: "hsla(204, 86%, 53%, 0.8)"})}
                        ${renderBalanceSheetBlock({label: "Working Capital", value: wcForDisplay + cashForDisplay, heightPercent: (wcForDisplay + cashForDisplay) / assetsForDisplay * 100, colorClass: "hsla(39, 92%, 63%, 0.8)"})}
                    `;
                 }

                const liabilityBlocks = `
                    ${renderBalanceSheetBlock({label: "Equity", value: equityForDisplay, heightPercent: eAndLForDisplay > 0 ? equityForDisplay / eAndLForDisplay * 100 : 0, colorClass: "hsla(221, 83%, 53%, 0.8)"})}
                    ${renderBalanceSheetBlock({label: "Debt", value: debtForDisplay, heightPercent: eAndLForDisplay > 0 ? debtForDisplay / eAndLForDisplay * 100 : 0, colorClass: "hsla(0, 84%, 60%, 0.8)"})}
                `;
                
                let runningOverlay = '';
                if (chapter >= 5 && chapter < 9) {
                    runningOverlay = `
                    <div class="running-overlay">
                        <div class="running-icon-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        </div>
                    </div>
                    `;
                }

                 visualHTML = `
                    <div class="machine-active-container">
                        <div class="balance-sheet-container">
                            <div class="balance-sheet-col">
                                <div class="balance-sheet-blocks">${assetBlocks}${runningOverlay}</div>
                                <div class="balance-sheet-total"><span>Assets</span> <span>${formatCurrency(assetsForDisplay)}</span></div>
                            </div>
                            <div class="balance-sheet-col">
                                <div class="balance-sheet-blocks">${liabilityBlocks}</div>
                                <div class="balance-sheet-total"><span>Equity & Liabilities</span> <span>${formatCurrency(eAndLForDisplay)}</span></div>
                            </div>
                        </div>
                    </div>
                 `;
            }

            // --- RENDER REVENUE BAR ---
            let revenueBarHTML = '';
            if (hasInjectedCapital && chapter >= 6 && chapter < 8) {
                const barWidth = chapter === 6 ? 100 : (revenue > 0 ? (remainingRevenue / revenue) * 100 : 0);
                const barText = formatCurrency(chapter === 6 ? revenue : remainingRevenue);
                revenueBarHTML = `
                    <div class="revenue-bar-outer">
                        <div class="revenue-bar-label">${chapter === 6 ? 'Revenue' : 'Remaining After Payments'}</div>
                        <div class="revenue-bar-wrapper">
                            <div class="revenue-bar-inner" style="width: ${barWidth}%; transition-duration: ${chapter === 6 ? '3s' : '0.5s'};"></div>
                            <div class="revenue-bar-text">${barText}</div>
                        </div>
                    </div>
                `;
            }
             if (hasInjectedCapital && chapter === 8) {
                const barWidth = revenue > 0 ? (netProfit / revenue) * 100 : 0;
                 revenueBarHTML = `
                    <div class="revenue-bar-outer">
                        <div class="revenue-bar-label">Net Profit</div>
                        <div class="revenue-bar-wrapper">
                            <div class="revenue-bar-inner" style="width: ${barWidth}%; background-color: hsla(142, 76%, 56%, 0.8);"></div>
                            <div class="revenue-bar-text" style="color: black;">${formatCurrency(netProfit)}</div>
                        </div>
                    </div>
                `;
            }


            // --- RENDER CONTROLS ---
            let controlsHTML;
            let description = currentChapter.description.replace('{capital}', `<strong>${formatCurrency(capital)}</strong>`);
            
            if (chapter === 1) {
                controlsHTML = `
                    <div class="chapter-form-container">
                        <div class="form-group">
                            <label for="company-name" class="form-label">Company Name</label>
                            <input id="company-name" type="text" class="input" value="${companyName}" placeholder="e.g., Stark Industries">
                        </div>
                    </div>
                `;
            } else if (chapter === 2) {
                controlsHTML = `
                    <div class="chapter-form-container" style="gap: 1rem;">
                        <div class="form-group">
                            <label for="total-capital" class="form-label">Enter Capital to Your Company</label>
                            <input id="total-capital" type="text" class="input font-mono" value="${totalCapital}" placeholder="e.g. 1000000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Composition of Debt and Equity</label>
                            <div style="display: flex; gap: 1rem;">
                                <div style="width: 50%;">
                                    <label for="equity-percent" class="form-label" style="color: hsl(221, 83%, 53%);">Equity %</label>
                                    <input id="equity-percent" type="text" class="input font-mono" value="${equityPercent}">
                                </div>
                                <div style="width: 50%;">
                                    <label for="debt-percent" class="form-label" style="color: hsl(0, 84%, 60%);">Debt %</label>
                                    <input id="debt-percent" type="text" class="input font-mono" value="${100 - equityPercent}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (chapter === 4) {
                 controlsHTML = `
                    <div class="chapter-form-container">
                        <p class="text-muted-foreground text-center" style="color: hsl(var(--muted-foreground)); text-align:center;">Total Capital: ${formatCurrency(capital)}</p>
                        <div class="form-group">
                            <label class="form-label">Fixed Assets (PPE)</label>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <input type="range" min="0" max="${capital}" value="${ppe}" step="${capital > 0 ? capital / 100 : 1}" class="slider" id="ppe-slider">
                                <span class="font-mono" style="width: 7rem; text-align: right; white-space: nowrap;">${formatCurrency(ppe)}</span>
                            </div>
                        </div>
                        <div class="form-group">
                             <div style="display: flex; align-items: center; justify-content: space-between;">
                                <label class="form-label">Working Capital</label>
                                <span class="font-mono" style="width: 7rem; text-align: right; white-space: nowrap;">${formatCurrency(workingCapital)}</span>
                            </div>
                        </div>
                    </div>
                 `;
            } else if (chapter === 5) {
                controlsHTML = `
                    <div class="chapter-form-container">
                        <div class="form-group">
                            <label for="asset-turnover" class="form-label">Asset Turnover</label>
                            <input id="asset-turnover" type="text" class="input" value="${assetTurnover}" placeholder="e.g., 2">
                            <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); padding-top: 0.25rem;">How many times your capital will 'turn over' to generate revenue. (Revenue = Capital ร Turnover)</p>
                        </div>
                    </div>`;
            } else if (chapter === 7) {
                const costItems = [
                    { key: 'opex', label: 'Operating Expenses', value: opex, placeholder: 'e.g. 10000' },
                    { key: 'interest', label: 'Interest Cost', value: interest, placeholder: 'e.g. 5000', condition: debt > 0 },
                ];
                controlsHTML = `
                 <div class="chapter-form-container" style="gap: 0.5rem; font-size:0.875rem;">
                    <!-- COGS -->
                    <div style="display:flex; align-items:center; justify-content: space-between; background-color: #f1f5f9; padding: 0.375rem; border-radius: 0.375rem;">
                        <span style="font-weight: 500;">Cost of Sales</span>
                        <div style="display:flex; align-items:center; gap: 0.5rem;">
                            <div style="position:relative;">
                                <input id="cogs-percent" type="text" class="input input-sm font-mono text-right" value="${cogsPercent}" style="width: 5rem; padding-right: 1.5rem;" ${payments.cogs.paid ? 'disabled' : ''}>
                                <span style="position:absolute; right:0.5rem; top:50%; transform: translateY(-50%); color: hsl(var(--muted-foreground))">%</span>
                            </div>
                             <div style="height: 2rem; width: 90px; display:flex; align-items:center; justify-content:flex-end; padding-right: 0.75rem;">
                                <span class="font-mono" style="color: hsl(var(--muted-foreground))">${formatCurrency(cogs)}</span>
                            </div>
                            ${payments.cogs.paid ? 
                                `<div style="width:58px; display:flex; justify-content:center;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>` 
                                : `<button id="pay-cogs" class="button button-sm primary">Pay</button>`}
                        </div>
                    </div>
                    <!-- Other costs -->
                    ${costItems.filter(i=>i.condition !== false).map(item => `
                        <div style="display:flex; align-items:center; justify-content: space-between; background-color: #f1f5f9; padding: 0.375rem; border-radius: 0.375rem;">
                            <span style="font-weight: 500;">${item.label}</span>
                            <div style="display:flex; align-items:center; gap: 0.5rem;">
                                <input id="input-${item.key}" type="text" class="input input-sm font-mono text-right" value="${item.value}" placeholder="${item.placeholder}" style="width: 7rem;" ${payments[item.key].paid ? 'disabled' : ''}>
                                ${payments[item.key].paid ?
                                    `<div style="width:58px; display:flex; justify-content:center;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>`
                                    : `<button id="pay-${item.key}" class="button button-sm primary">Pay</button>`
                                }
                            </div>
                        </div>
                    `).join('')}
                    <!-- Tax -->
                    ${pbt > 0 ? `
                    <div style="display:flex; align-items:center; justify-content: space-between; background-color: #f1f5f9; padding: 0.375rem; border-radius: 0.375rem;">
                        <span style="font-weight: 500;">Taxes</span>
                        <div style="display:flex; align-items:center; gap: 0.5rem;">
                             <div style="position:relative;">
                                <input id="tax-percent" type="text" class="input input-sm font-mono text-right" value="${taxPercent}" style="width: 5rem; padding-right: 1.5rem;" ${payments.tax.paid ? 'disabled' : ''}>
                                <span style="position:absolute; right:0.5rem; top:50%; transform: translateY(-50%); color: hsl(var(--muted-foreground))">%</span>
                            </div>
                             <div style="height: 2rem; width: 90px; display:flex; align-items:center; justify-content:flex-end; padding-right: 0.75rem;">
                                <span class="font-mono" style="color: hsl(var(--muted-foreground))">${formatCurrency(tax)}</span>
                            </div>
                            ${payments.tax.paid ? 
                                `<div style="width:58px; display:flex; justify-content:center;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>` 
                                : `<button id="pay-tax" class="button button-sm primary">Pay</button>`}
                        </div>
                    </div>` : ''}
                 </div>`;
            } else if (chapter === 8) {
                controlsHTML = `
                <div class="chapter-form-container" style="background-color: #f1f5f9; padding: 1rem; border-radius: 0.5rem; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:baseline;">
                        <span style="font-weight:500;">Net Profit</span>
                        <span class="font-mono" style="font-size: 1.125rem; font-weight: 600; color: black;">${formatCurrency(netProfit)}</span>
                    </div>
                    <div style="border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <label for="dividends-percent" class="form-label">Dividends Payout (%)</label>
                        <div style="position:relative; margin-top: 0.25rem;">
                            <input id="dividends-percent" type="text" class="input font-mono" value="${dividendPercent}" style="padding-right: 2rem;">
                            <span style="position:absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: hsl(var(--muted-foreground)); font-family: monospace;">%</span>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:baseline; font-size: 0.875rem;">
                        <span style="color: hsl(var(--muted-foreground));">Dividend Amount</span>
                        <span class="font-mono">${formatCurrency(dividends)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:baseline; font-weight: 700; border-top: 1px solid #e2e8f0; padding-top: 1rem; margin-top: 1rem;">
                        <span>Retained Earnings</span>
                        <span class="font-mono" style="font-size: 1.125rem;">${formatCurrency(retainedEarnings)}</span>
                    </div>
                </div>
                `;
            } else if (chapter === 9) {
                const growth = totalAssetsBS > 0 && (totalAssetsBS-retainedEarnings) !== 0 ? (retainedEarnings / (totalAssetsBS-retainedEarnings)) * 100 : 0;
                let growthText;
                if (retainedEarnings > 0) {
                    growthText = `The company's assets grew by ${growth.toFixed(2)}% this year.`
                } else if (retainedEarnings < 0) {
                    growthText = `The company's assets decreased by ${Math.abs(growth).toFixed(2)}% this year.`
                } else {
                    growthText = `The company's asset value remained the same this year.`
                }
                controlsHTML = `<p style="font-weight: 600; text-align: center; margin-top: 1rem; font-size: 1.125rem;">${growthText}</p>`;
            } else {
                controlsHTML = '';
            }

            // --- RENDER BUTTONS ---
            let buttonText, buttonAction, nextDisabled = false;
            if (chapter === 1) { buttonText = "Form Company"; buttonAction = nextChapter; nextDisabled = !companyName.trim(); }
            else if (chapter === 2) { buttonText = 'Inject Capital'; buttonAction = handleInjectCapital; nextDisabled = totalCapital <= 0; }
            else if (chapter === 3) { buttonText = 'Next'; buttonAction = nextChapter; }
            else if (chapter === 4) { buttonText = 'Deploy Capital'; buttonAction = nextChapter; }
            else if (chapter === 5) { buttonText = 'Calculate Revenue'; buttonAction = nextChapter; nextDisabled = getNumericValue(assetTurnover) <= 0 }
            else if (chapter === 6) { buttonText = 'Distribute Revenue'; buttonAction = nextChapter; }
            else if (chapter === 7) { buttonText = 'See Profit'; buttonAction = nextChapter; nextDisabled = !Object.values(payments).every(p => p.paid); if(pbt <= 0 && !payments.tax.paid) nextDisabled = !payments.cogs.paid || !payments.opex.paid || !payments.interest.paid }
            else if (chapter === 8) { buttonText = "Final Balance Sheet"; buttonAction = nextChapter; }
            else if (chapter === 9) { buttonText = 'Finish'; buttonAction = nextChapter; }

            const actionButtonsHTML = `
                <div class="chapter-actions">
                    <button id="prev-btn" class="button ghost button-icon-text" ${chapter === 1 ? 'disabled' : ''}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                        Previous
                    </button>
                    ${buttonText ? `
                    <button id="next-btn" class="button primary button-icon-text" ${nextDisabled ? 'disabled' : ''}>
                        ${buttonText}
                        ${chapter < 9 ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>` : ''}
                    </button>` : ''}
                </div>`;
            
            // --- COMBINE AND INJECT ---
            mainContent.innerHTML = `
                <div class="engine-visual-container">
                    <div class="machine-visual-outer">
                        <div class="machine-visual-inner">${visualHTML}</div>
                        <div class="revenue-container">${revenueBarHTML}</div>
                    </div>
                </div>
                <div class="engine-controls-container">
                    <div class="controls-content">
                        <div class="controls-inner">
                            <h2 class="chapter-title">${currentChapter.name}</h2>
                            <p class="chapter-description">${description}</p>
                            ${controlsHTML || ''}
                        </div>
                        ${actionButtonsHTML}
                    </div>
                </div>
            `;
            
            // --- ATTACH EVENT LISTENERS for dynamic content ---
            if (document.getElementById('prev-btn')) document.getElementById('prev-btn').onclick = prevChapter;
            if (document.getElementById('next-btn')) document.getElementById('next-btn').onclick = buttonAction;

            attachChapterEventListeners(financials);
        };

        const attachChapterEventListeners = (financials) => {
            if (chapter === 1) {
                const input = document.getElementById('company-name');
                input.oninput = (e) => { companyName = e.target.value; render(); };
                input.focus();
            }
            if (chapter === 2) {
                const capitalInput = document.getElementById('total-capital');
                capitalInput.oninput = (e) => { if (/^\d*$/.test(e.target.value)) totalCapital = e.target.value === '' ? 0 : parseInt(e.target.value, 10); render(); };
                
                const equityInput = document.getElementById('equity-percent');
                equityInput.oninput = (e) => {
                    if (/^\d*$/.test(e.target.value)) {
                        let numValue = e.target.value === '' ? 0 : parseInt(e.target.value, 10);
                        if (numValue > 100) numValue = 100;
                        equityPercent = numValue;
                        render();
                    }
                };
            }
            if (chapter === 4) {
                const slider = document.getElementById('ppe-slider');
                slider.oninput = (e) => {
                    ppe = parseInt(e.target.value, 10);
                    workingCapital = financials.capital - ppe;
                    render();
                };
            }
             if (chapter === 5) {
                const turnoverInput = document.getElementById('asset-turnover');
                turnoverInput.oninput = (e) => {
                    const val = e.target.value;
                    if (val === '' || /^\d*\.?\d*$/.test(val)) {
                        assetTurnover = val;
                        render();
                    }
                }
            }
            if(chapter === 7) {
                const { cogs, opex: opexVal, interest: interestVal, tax } = financials;
                if(document.getElementById('cogs-percent')) {
                    document.getElementById('cogs-percent').oninput = (e) => {
                         const val = e.target.value;
                         if (/^\d*$/.test(val)) {
                            const num = val === '' ? '' : parseInt(val, 10);
                            if (num === '' || (num >= 0 && num <= 100)) cogsPercent = num;
                            render();
                         }
                    }
                }
                if(document.getElementById('pay-cogs')) document.getElementById('pay-cogs').onclick = () => handlePay('cogs', cogs);
                
                if(document.getElementById('input-opex')) {
                    document.getElementById('input-opex').oninput = e => { if (/^\d*\.?\d*$/.test(e.target.value)) opex = e.target.value; render(); };
                    if(document.getElementById('pay-opex')) document.getElementById('pay-opex').onclick = () => handlePay('opex', getNumericValue(opex));
                }
                if(document.getElementById('input-interest')) {
                    document.getElementById('input-interest').oninput = e => { if (/^\d*\.?\d*$/.test(e.target.value)) interest = e.target.value; render(); };
                    if(document.getElementById('pay-interest')) document.getElementById('pay-interest').onclick = () => handlePay('interest', getNumericValue(interest));
                }

                if(document.getElementById('tax-percent')) {
                    document.getElementById('tax-percent').oninput = (e) => {
                         const val = e.target.value;
                         if (/^\d*$/.test(val)) {
                            const num = val === '' ? '' : parseInt(val, 10);
                            if (num === '' || (num >= 0 && num <= 100)) taxPercent = num;
                            render();
                         }
                    }
                }
                if(document.getElementById('pay-tax')) document.getElementById('pay-tax').onclick = () => handlePay('tax', tax);
            }
            if(chapter === 8) {
                document.getElementById('dividends-percent').oninput = e => {
                    const val = e.target.value;
                    if (/^\d*$/.test(val)) {
                        const num = val === '' ? '' : parseInt(val, 10);
                        if (num === '' || (num >= 0 && num <= 100)) dividendPercent = num;
                        render();
                    }
                };
            }
        }
        
        const resetChapterState = (targetChapter) => {
            if (targetChapter <= 2) {
                equity = 0;
                debt = 0;
                ppe = 0;
                workingCapital = 0;
                totalCapital = 1000000;
                equityPercent = 75;
            }
            if (targetChapter <= 3) {
                ppe = 0;
                workingCapital = 0;
            }
            if (targetChapter <= 6) {
                 payments = { cogs: { paid: false }, opex: { paid: false }, interest: { paid: false }, tax: { paid: false }};
            }
        };

        const setupForChapter = () => {
            const { capital, revenue, debt: currentDebt } = calculateFinancials();
             if (chapter === 4) {
                if (capital > 0 && ppe === 0 && workingCapital === 0) {
                  const initialPpe = capital * 0.6;
                  ppe = initialPpe;
                  workingCapital = capital - initialPpe;
                }
            }
            if (chapter === 7) {
                remainingRevenue = revenue;
                if (opex === '') {
                    opex = revenue > 0 ? Math.round(revenue * 0.15) : 0;
                }
                if (interest === '' && currentDebt > 0) {
                    interest = Math.round(currentDebt * 0.1);
                }
            }
             if (chapter === 8) {
                if(dividendPercent === '') dividendPercent = 50;
            }
        };

        const nextChapter = () => {
            if(chapter > 9) return;
            chapter++;
            resetChapterState(chapter);
            setupForChapter();
            render();
        };

        const prevChapter = () => {
            if(chapter <= 1) return;
            chapter--;
            resetChapterState(chapter);
            setupForChapter();
            render();
        };

        const handleInjectCapital = () => {
            if (totalCapital > 0) {
                equity = totalCapital * (equityPercent / 100);
                debt = totalCapital * ((100-equityPercent) / 100);
                nextChapter();
            }
        };
        
        const handlePay = (key, cost) => {
            if (payments[key].paid) return;
            remainingRevenue -= cost;
            payments[key].paid = true;
            render();
        };

        // --- INITIALIZATION ---
        document.getElementById('explore-button').onclick = () => {
            coverView.classList.add('hidden');
            engineView.classList.add('visible');
            setupForChapter();
            render();
        };
        document.getElementById('reload-button').onclick = () => window.location.reload();

    });
    </script>
</body>
</html>
