<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanjeev Khanal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 224 71.4% 4.1%;
            --primary: 217 91% 60%;
            --primary-foreground: 210 20% 98%;
            --muted: 220 14.3% 95.9%;
            --muted-foreground: 220 8.9% 46.1%;
            --border: 220 13% 91%;
            --radius: 0.5rem;
        }
        body {
            font-family: Inter, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes pulse-slow {
          '0%, 100%': { opacity: '0.2', transform: 'scale(1)' },
          '50%': { opacity: '0.4', transform: 'scale(1.05)' },
        }
        .animate-pulse-slow {
            animation: pulse-slow 10s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root">
        <!-- App will be rendered here -->
    </div>

    <script>
        const ICONS = {
            arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-3 h-6 w-6 transition-transform duration-300 group-hover:translate-x-1.5"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            arrowLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
            linkedin: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect width="4" height="12" x="2" y="9"/><circle cx="4" cy="4" r="2"/></svg>`,
            send: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>`,
            refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-white/70 animate-spin"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-green-500"><path d="M20 6 9 17l-5-5"/></svg>`,
        };

        const state = {
            view: 'cover', // 'cover' or 'engine'
            chapter: 1,
            companyName: 'Stark Industries',
            totalCapital: 1000000,
            totalCapitalDisplay: '1000000',
            equityPercent: 75,
            equityPercentDisplay: '75',
            equity: 0,
            debt: 0,
            ppe: 0,
            workingCapital: 0,
            assetTurnover: 2,
            cogsPercent: 60,
            opex: '',
            interest: '',
            taxPercent: 25,
            dividendPercent: 50,
            payments: { cogs: false, opex: false, interest: false, tax: false },
            remainingRevenue: 0,
        };

        function formatCurrency(value) {
            if (Math.abs(value) >= 10000000) {
                return 'Rs ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 }).format(value / 10000000) + ' Cr';
            }
            if (Math.abs(value) >= 100000) {
                return 'Rs ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 }).format(value / 100000) + ' Lakhs';
            }
            return 'Rs ' + new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(value);
        }

        function render() {
            const root = document.getElementById('root');
            if (state.view === 'cover') {
                root.innerHTML = `
                <div class="relative min-h-screen w-full overflow-hidden bg-slate-50 text-slate-800 antialiased transition-opacity duration-700 ease-out">
                    <div class="absolute inset-0 -z-10">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(60,120,255,0.08),transparent_40%)]"></div>
                        <div class="absolute -top-1/4 -right-1/4 w-3/4 h-3/4 bg-blue-500/20 rounded-full blur-[120px] opacity-20 animate-pulse-slow" style="animation-duration: 8s;"></div>
                        <div class="absolute -bottom-1/4 -left-1/4 w-2/3 h-2/3 bg-cyan-500/20 rounded-full blur-[120px] opacity-20 animate-pulse-slow" style="animation-delay: 2s; animation-duration: 10s;"></div>
                    </div>
                    <main class="relative z-10 flex min-h-screen flex-col items-center justify-center p-4">
                        <div class="grid w-full max-w-5xl grid-cols-1 gap-12 text-center md:grid-cols-2 md:text-left">
                            <div class="flex flex-col justify-center md:items-start items-center">
                                <h1 class="text-5xl font-bold tracking-tight text-slate-900 md:text-6xl">Sanjeev Khanal</h1>
                                <p class="mt-4 text-lg text-slate-600">Semi-Qualified CA</p>
                                <div class="mt-8 flex items-center justify-center gap-8 text-sm font-medium text-slate-500 md:justify-start">
                                    <a href="mailto:mail@sanjeevkhanal.com.np" class="flex items-center gap-2 hover:text-blue-600 transition-colors">${ICONS.send}<span>Contact Me</span></a>
                                    <a href="https://www.linkedin.com/in/sanjeev-khanal" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 hover:text-blue-600 transition-colors">${ICONS.linkedin}<span>LinkedIn</span></a>
                                </div>
                            </div>
                            <div class="flex flex-col justify-center border-t-2 border-slate-200 pt-8 md:border-t-0 md:border-l-2 md:border-slate-200 md:pt-0 md:pl-12">
                                <h2 class="text-4xl font-extrabold tracking-tighter text-slate-900 md:text-5xl">Welcome.</h2>
                                <p class="mt-6 max-w-xl text-lg text-slate-600">Finance is a powerful engine that drives our world. Curious to see how it works? Let's explore it together.</p>
                                <div class="mt-10">
                                    <button id="enter-button" class="group inline-flex items-center justify-center rounded-full bg-blue-600 px-8 py-4 text-lg font-bold text-white transition-all duration-300 hover:bg-blue-600/90 hover:shadow-2xl hover:shadow-blue-500/30 transform hover:-translate-y-1">
                                        Explore ${ICONS.arrowRight}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>`;
                document.getElementById('enter-button').addEventListener('click', () => {
                    state.view = 'engine';
                    const coverDiv = root.firstChild;
                    coverDiv.style.opacity = 0;
                    setTimeout(() => render(), 700);
                });
            } else {
                root.innerHTML = `<div id="engine-view" class="transition-opacity duration-700 ease-out opacity-0"></div>`;
                renderEngineView();
                setTimeout(() => {
                    document.getElementById('engine-view').style.opacity = 1;
                }, 10);
            }
        }

        function renderEngineView() {
            const activeElement = document.activeElement;
            const activeElementId = activeElement ? activeElement.id : null;
            let selectionStart, selectionEnd;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                selectionStart = activeElement.selectionStart;
                selectionEnd = activeElement.selectionEnd;
            }

            // Calculations
            const debtPercent = 100 - state.equityPercent;
            const capital = state.equity + state.debt;
            const revenue = capital * Number(state.assetTurnover);
            const cogs = revenue > 0 ? revenue * (Number(state.cogsPercent) / 100) : 0;
            const opex = Number(state.opex);
            const interest = Number(state.interest);
            const pbt = revenue - cogs - opex - interest;
            const tax = pbt > 0 ? pbt * (Number(state.taxPercent) / 100) : 0;
            const netProfit = pbt - tax;
            const dividends = netProfit > 0 ? netProfit * (Number(state.dividendPercent) / 100) : 0;
            const retainedEarnings = netProfit - dividends;
            const cashPostAsset = capital - state.ppe - state.workingCapital;
            const totalAssetsBS = (state.chapter < 4) ? capital : state.ppe + state.workingCapital + cashPostAsset;
            const totalEquityBS = state.equity + (state.chapter >= 9 ? retainedEarnings : 0);
            const totalLiabilitiesBS = state.debt;
            const totalEquityAndLiabilities = totalEquityBS + totalLiabilitiesBS;

            const hasInjectedCapital = capital > 0;
            const canProceed = () => {
                if (state.chapter === 1 && !state.companyName.trim()) return false;
                if (state.chapter === 2 && state.totalCapital <= 0) return false;
                return true;
            };

            const chapters = [
                { name: "The Shell", description: "Every great enterprise begins as a simple idea, a legal 'shell.' It has a name and a purpose, but it is an empty vessel. It has no assets, no employees, and no capital. It is pure potential, waiting for the fuel it needs to start its engine. Let's give our company a name to begin." },
                { name: "The Fuel", description: "A company needs fuel to operate. This fuel is Capital, the money used to purchase assets and fund operations. It comes from two primary sources, Equity which is cash invested by the owners, and Debt which is cash borrowed from lenders. This mix, known as the Capital Structure, is a crucial decision that will define the company's risk and potential returns." },
                { name: "The Conversion", description: `The fuel is in the tank. The capital you have raised, a total of <strong>${formatCurrency(capital)}</strong>, is now cash in the company's bank account. This is the most basic form of an asset. But cash itself does not generate returns, it must be converted into productive assets. The balance sheet is born. On one side, what the company owns (Assets), and on the other, who has a claim to those assets (Equity and Liabilities).` },
                { name: "The Deployment", description: "Cash must be put to work. A portion is used to acquire Fixed Assets, also called Property, Plant, and Equipment, which are the long term tools the business will use to create its products or services. The remainder is kept as Working Capital, the lifeblood for day to day operations like paying salaries and buying inventory. This allocation is a critical trade off between long term investment and short term liquidity." },
                { name: "The Output", description: "The machine is now running. Assets are working to generate Revenue, the total sales earned from customers. The efficiency of this process is measured by Asset Turnover (Revenue / Assets). A higher turnover means the company is squeezing more sales from every rupee invested in its assets. This ratio is a powerful indicator of operational performance." },
                { name: "The Reality", description: "Revenue is not profit, it is simply the starting point. The cash generated from sales does not belong to the company yet, it is first claimed by all the parties who helped generate it. This is the reality of business. Before owners can claim their share, the costs of running the machine must be paid. This process of distribution is what the Income Statement is all about." },
                { name: "The Distribution", description: "The revenue must now be distributed. First, we pay the direct costs of production (Cost of Goods Sold). Then come the overheads, like marketing and administrative salaries (Operating Expenses). Next, lenders must be paid their Interest on the debt we took. Finally, the government takes its share in the form of Taxes. What remains after this cascade of payments is the Net Profit." },
                { name: "The Compounding", description: "The Net Profit is what's left for the owners. They face a choice, withdraw the cash as Dividends for their personal use, or reinvest it back into the business as Retained Earnings. Reinvesting the profits increases the company's equity base, giving it more capital to grow in the next cycle. This is the engine of compounding, where profits from one period fuel the growth of the next." },
                { name: "The Engine of Value", description: "The cycle is complete. By reinvesting the profits, the company's equity has grown, making it more valuable. This is the fundamental engine of finance, capital is deployed to create assets, assets generate profit, and a portion of that profit is retained to increase the capital base. The machine gets bigger and more powerful with every turn. You have just built the engine of value creation." },
            ];

            const currentChapter = chapters[state.chapter - 1];

            function getChapterContent() {
                if (state.chapter === 1) {
                    return `
                    <p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>
                    <div class="space-y-2 text-left w-full max-w-sm">
                        <label for="company-name" class="font-medium text-gray-700">Company Name</label>
                        <input id="company-name" type="text" value="${state.companyName}" placeholder="e.g., Stark Industries" class="text-lg flex h-10 w-full rounded-md border border-blue-600/30 bg-white px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600">
                    </div>`;
                }
                if (state.chapter === 2) {
                    return `
                    <p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>
                    <div class="space-y-6 text-sm text-left w-full max-w-sm">
                        <div>
                            <label for="total-capital" class="font-medium text-gray-700">Enter Capital to Your Company</label>
                            <input id="total-capital" type="text" value="${state.totalCapitalDisplay}" placeholder="e.g. 1000000" class="font-mono mt-1 text-lg flex h-10 w-full rounded-md border border-blue-600/30 bg-white px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600">
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Select Composition of Debt and Equity</label>
                            <div class="flex gap-4 mt-1">
                                <div class="w-1/2">
                                    <label for="equity" class="font-medium text-blue-700">Equity %</label>
                                    <input id="equity" type="text" value="${state.equityPercentDisplay}" class="font-mono mt-1 flex h-10 w-full rounded-md border border-blue-600/30 bg-white px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600">
                                </div>
                                <div class="w-1/2">
                                    <label for="debt" class="font-medium text-red-700">Debt %</label>
                                    <input id="debt" type="text" value="${debtPercent}" readonly class="font-mono mt-1 bg-slate-100 flex h-10 w-full rounded-md border border-blue-600/30 px-3 py-2">
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                 if (state.chapter === 4) {
                    return `
                        <p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>
                        <div class="space-y-6 text-xs text-left w-full max-w-sm">
                            <p class="text-slate-600 text-center">Total Capital: ${formatCurrency(capital)}</p>
                            <div>
                                <label class="font-medium">Fixed Assets (PPE)</label>
                                <div class="flex items-center gap-4">
                                    <input id="ppe-slider" type="range" min="0" max="${capital}" step="${capital > 0 ? capital / 100 : 1}" value="${state.ppe}" class="w-full">
                                    <span class="font-mono w-28 text-right whitespace-nowrap">${formatCurrency(state.ppe)}</span>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between">
                                    <label class="font-medium">Working Capital</label>
                                    <span class="font-mono w-28 text-right whitespace-nowrap">${formatCurrency(state.workingCapital)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                if (state.chapter === 5) {
                    return `
                        <p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>
                        <div class="space-y-2 text-left w-full max-w-sm">
                            <label for="asset-turnover" class="font-medium text-gray-700">Asset Turnover</label>
                            <input id="asset-turnover" type="text" value="${state.assetTurnover}" placeholder="e.g., 2" class="text-lg flex h-10 w-full rounded-md border border-blue-600/30 bg-white px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600">
                            <p class="text-xs text-slate-500 pt-1">How many times your capital will 'turn over' to generate revenue. (Revenue = Capital Ã— Turnover)</p>
                        </div>
                    `;
                }
                if (state.chapter === 7) {
                  const costItems = [
                      { key: 'opex', label: 'Operating Expenses', value: state.opex, placeholder: 'e.g. 10000', condition: true },
                      { key: 'interest', label: 'Interest Cost', value: state.interest, placeholder: 'e.g. 5000', condition: state.debt > 0 },
                  ];

                  let costHtml = `
                    <div class="flex items-center justify-between bg-slate-100 p-1.5 rounded-md">
                        <span class="font-medium">Cost of Sales</span>
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <input id="cogs-percent" type="text" value="${state.cogsPercent}" class="h-8 w-20 font-mono text-right pr-6 rounded-md border border-blue-600/30" ${state.payments.cogs ? 'disabled' : ''}>
                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500">%</span>
                            </div>
                            <div class="h-8 w-[90px] flex items-center justify-end pr-3">
                                <span class="font-mono text-slate-500">${formatCurrency(cogs)}</span>
                            </div>
                            ${state.payments.cogs ? `<div class="w-[58px] flex justify-center">${ICONS.check}</div>` : `<button data-cost="cogs" class="pay-btn h-8 px-3 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">Pay</button>`}
                        </div>
                    </div>`;

                  costItems.filter(item => item.condition).forEach(item => {
                      costHtml += `
                          <div class="flex items-center justify-between bg-slate-100 p-1.5 rounded-md">
                              <span class="font-medium">${item.label}</span>
                              <div class="flex items-center gap-2">
                                  <input data-cost-input="${item.key}" type="text" value="${item.value}" placeholder="${item.placeholder}" class="h-8 w-28 font-mono text-right rounded-md border border-blue-600/30" ${state.payments[item.key] ? 'disabled' : ''}>
                                  ${state.payments[item.key] ? `<div class="w-[58px] flex justify-center">${ICONS.check}</div>` : `<button data-cost="${item.key}" class="pay-btn h-8 px-3 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">Pay</button>`}
                              </div>
                          </div>`;
                  });

                  if (pbt > 0) {
                      costHtml += `
                          <div class="flex items-center justify-between bg-slate-100 p-1.5 rounded-md">
                              <span class="font-medium">Taxes</span>
                              <div class="flex items-center gap-2">
                                  <div class="relative">
                                      <input id="tax-percent" type="text" value="${state.taxPercent}" class="h-8 w-20 font-mono text-right pr-6 rounded-md border border-blue-600/30" ${state.payments.tax ? 'disabled' : ''}>
                                      <span class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500">%</span>
                                  </div>
                                  <div class="h-8 w-[90px] flex items-center justify-end pr-3">
                                      <span class="font-mono text-slate-500">${formatCurrency(tax)}</span>
                                  </div>
                                  ${state.payments.tax ? `<div class="w-[58px] flex justify-center">${ICONS.check}</div>` : `<button data-cost="tax" class="pay-btn h-8 px-3 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">Pay</button>`}
                              </div>
                          </div>`;
                  }

                  return `
                      <p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>
                      <div class="space-y-2 text-sm text-left w-full max-w-sm">${costHtml}</div>`;
                }
                if (state.chapter === 8) {
                    return `
                        <p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>
                        <div class="space-y-4 text-sm text-left w-full max-w-sm bg-slate-100 p-4 rounded-lg shadow-inner">
                            <div class="flex justify-between items-baseline">
                                <span class="font-medium">Net Profit</span>
                                <span class="font-mono text-lg font-semibold text-black">${formatCurrency(netProfit)}</span>
                            </div>
                            <div class="border-t pt-4">
                                <label for="dividends-percent" class="font-medium text-gray-700">Dividends Payout (%)</label>
                                <div class="relative">
                                    <input id="dividends-percent" type="text" value="${state.dividendPercent}" class="font-mono mt-1 pr-8 flex h-10 w-full rounded-md border border-blue-600/30 bg-white px-3 py-2 text-base ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 font-mono mt-0.5">%</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-baseline text-sm">
                                <span class="text-slate-600">Dividend Amount</span>
                                <span class="font-mono">${formatCurrency(dividends)}</span>
                            </div>
                            <div class="flex justify-between items-baseline font-bold border-t pt-4 mt-4">
                                <span>Retained Earnings</span>
                                <span class="font-mono text-lg">${formatCurrency(retainedEarnings)}</span>
                            </div>
                        </div>
                    `;
                }
                 if (state.chapter === 9) {
                    const growth = totalAssetsBS > 0 ? (retainedEarnings / (totalAssetsBS-retainedEarnings)) * 100 : 0;
                    let growthText;
                    if (retainedEarnings > 0) {
                        growthText = `The company's assets grew by ${growth.toFixed(2)}% this year.`
                    } else if (retainedEarnings < 0) {
                        growthText = `The company's assets decreased by ${Math.abs(growth).toFixed(2)}% this year.`
                    } else {
                        growthText = `The company's asset value remained the same this year.`
                    }
                    
                    return `
                       <p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>
                       <p class="font-semibold text-center mt-4 text-lg">${growthText}</p>
                    `;
                }
                return `<p class="text-slate-600 text-lg mb-8 text-justify">${currentChapter.description}</p>`;
            }

            function getActionButtons() {
                let buttonText = "Next";
                let buttonAction = "next";
                
                if(state.chapter === 1) buttonText = "Form Company";
                else if (state.chapter === 2) {
                    buttonText = 'Inject Capital';
                    buttonAction = 'inject';
                } else if (state.chapter === 4) buttonText = 'Deploy Capital';
                else if (state.chapter === 5) buttonText = 'Calculate Revenue';
                else if (state.chapter === 6) buttonText = 'Distribute Revenue';
                else if (state.chapter === 7) buttonText = 'See Profit';
                else if (state.chapter === 8) buttonText = "Final Balance Sheet";
                else if (state.chapter === 9) buttonText = 'Finish';

                let buttons = `<button id="prev-btn" class="flex items-center justify-center h-10 px-4 py-2 rounded-md text-sm font-medium hover:bg-slate-200" ${state.chapter === 1 ? 'disabled' : ''}>${ICONS.arrowLeft}Previous</button>`;
                if (buttonText) {
                    buttons += `<button id="next-btn" data-action="${buttonAction}" class="bg-blue-600 text-white shadow-lg shadow-blue-600/20 flex items-center justify-center h-11 px-8 rounded-md text-sm font-medium hover:bg-blue-700 disabled:opacity-50" ${!canProceed() ? 'disabled' : ''}>
                        ${buttonText}
                        ${state.chapter < 9 ? ICONS.arrowRight.replace('ml-3', 'ml-2').replace('h-6 w-6', 'h-4 w-4') : ''}
                    </button>`;
                }
                return buttons;
            }

            function getBalanceSheetBlock(label, value, heightPercent, colorClass) {
                if (value <= 0) return '';
                let content;
                if (heightPercent < 5) content = '';
                else if (heightPercent < 15) {
                    content = `<div class="flex justify-center items-center gap-2 px-2">
                                <span class="font-bold text-[10px] whitespace-nowrap">${label}</span>
                                <span class="text-[10px] font-mono whitespace-nowrap">${formatCurrency(value)}</span>
                              </div>`;
                } else {
                    content = `<div class="flex flex-col justify-center items-center text-center">
                                <span class="font-bold text-sm">${label}</span>
                                <span class="text-xs font-mono">${formatCurrency(value)}</span>
                              </div>`;
                }
                return `<div class="rounded p-1 text-white flex justify-center items-center ${colorClass} transition-all duration-500" style="height: ${heightPercent}%">${content}</div>`;
            }

            function getMachineVisual() {
                if (state.chapter < 2 || (state.chapter >= 2 && !hasInjectedCapital)) {
                    return `<div class="flex items-center justify-center h-full">
                                <div class="w-[60vh] h-full relative">
                                    <div class="absolute inset-0 bg-white/20 border-2 border-gray-300 rounded-xl shadow-lg"></div>
                                    <div class="absolute top-1 left-1 w-full h-full bg-black/5 rounded-xl -z-10" style="transform: skew(-4deg, -2deg)"></div>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                        <h2 class="text-2xl font-bold tracking-widest uppercase">${state.companyName.trim() ? state.companyName : 'YOUR COMPANY'}</h2>
                                        <p class="text-sm">Incorporated 2026</p>
                                    </div>
                                </div>
                            </div>`;
                }

                const showCompounded = state.chapter >= 9;
                const ppeForDisplay = state.ppe;
                const wcForDisplay = state.workingCapital;
                const cashForDisplay = cashPostAsset + (showCompounded ? retainedEarnings : 0);
                const assetsForDisplay = (state.chapter < 4) ? capital : ppeForDisplay + wcForDisplay + cashForDisplay;
                const equityForDisplay = state.equity + (showCompounded ? retainedEarnings : 0);
                const debtForDisplay = state.debt;
                const eAndLForDisplay = equityForDisplay + debtForDisplay;

                let assetsContent = '';
                if (state.chapter < 4) {
                    assetsContent = getBalanceSheetBlock("Cash", capital, 100, "bg-emerald-500/80");
                } else {
                    const ppeHeight = ppeForDisplay > 0 ? (ppeForDisplay / assetsForDisplay * 100) : 0;
                    const wcHeight = wcForDisplay > 0 ? (wcForDisplay / assetsForDisplay * 100) : 0;
                    const cashHeight = cashForDisplay > 0 ? (cashForDisplay / assetsForDisplay * 100) : 0;
                    const wcAndCashHeight = showCompounded && (wcForDisplay + cashForDisplay > 0) ? ((wcForDisplay + cashForDisplay) / assetsForDisplay * 100) : 0;

                    assetsContent = getBalanceSheetBlock("Fixed Assets (PPE)", ppeForDisplay, ppeHeight, "bg-sky-500/80");
                    if (showCompounded) {
                        assetsContent += getBalanceSheetBlock("Working Capital", wcForDisplay + cashForDisplay, wcAndCashHeight, "bg-amber-500/80");
                    } else {
                        assetsContent += getBalanceSheetBlock("Working Capital", wcForDisplay, wcHeight, "bg-amber-500/80");
                        assetsContent += getBalanceSheetBlock("Cash", cashForDisplay, cashHeight, "bg-emerald-500/80");
                    }
                }
                
                let revenueBar = '';
                if (state.chapter >= 6 && state.chapter < 8 && hasInjectedCapital) {
                     revenueBar = `<div class="w-full max-w-2xl mt-1">
                        <div class="text-center text-xs font-semibold text-slate-500 mb-1">${state.chapter === 6 ? 'Revenue' : 'Remaining After Payments'}</div>
                        <div class="h-16 w-full bg-slate-200/70 rounded-md p-1 border relative overflow-hidden">
                            <div class="h-full bg-emerald-500/80 rounded-sm transition-all duration-500" style="width: ${state.chapter === 6 ? '100%' : `${(state.remainingRevenue / revenue) * 100}%`}"></div>
                            <div class="absolute inset-0 flex items-center justify-center font-mono text-slate-900 text-lg">${formatCurrency(state.chapter === 6 ? revenue : state.remainingRevenue)}</div>
                        </div>
                     </div>`;
                }
                 if (state.chapter === 8 && hasInjectedCapital) {
                    revenueBar = `<div class="w-full max-w-2xl mt-1">
                        <div class="text-center text-xs font-semibold text-slate-500 mb-1">Net Profit</div>
                        <div class="h-16 w-full bg-slate-200/70 rounded-md p-1 border relative overflow-hidden">
                            <div class="h-full bg-emerald-500/80 rounded-sm" style="width: ${(netProfit / revenue) * 100}%"></div>
                            <div class="absolute inset-0 flex items-center justify-center font-mono text-black text-lg">${formatCurrency(netProfit)}</div>
                        </div>
                    </div>`;
                }

                return `
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="w-full max-w-2xl flex-none h-[60vh]">
                        <div class="w-full flex items-stretch justify-center p-4 gap-4 h-full flex-none">
                            <div class="w-1/2 h-full flex flex-col">
                                <div class="w-full flex-1 flex flex-col bg-slate-200/30 rounded-md p-1 gap-1 border relative">
                                    ${assetsContent}
                                    ${(state.chapter >= 5 && state.chapter < 9) ? `<div class="absolute inset-0 flex items-center justify-center bg-slate-900/20">${ICONS.refresh}</div>` : ''}
                                </div>
                                <h4 class="font-semibold text-center text-xs mt-2 text-slate-500 flex justify-between items-center px-1 h-10"><span>Assets</span><span class="font-mono whitespace-nowrap">${formatCurrency(assetsForDisplay)}</span></h4>
                            </div>
                            <div class="w-1/2 h-full flex flex-col">
                                <div class="w-full flex-1 flex flex-col bg-slate-200/30 rounded-md p-1 gap-1 border">
                                    ${getBalanceSheetBlock("Equity", equityForDisplay, eAndLForDisplay > 0 ? (equityForDisplay / eAndLForDisplay * 100) : 0, "bg-blue-500/80")}
                                    ${getBalanceSheetBlock("Debt", debtForDisplay, eAndLForDisplay > 0 ? (debtForDisplay / eAndLForDisplay * 100) : 0, "bg-red-500/80")}
                                </div>
                                <h4 class="font-semibold text-center text-xs mt-2 text-slate-500 flex justify-between items-center px-1 h-10"><span class="flex-shrink-0">Equity & Liabilities</span><span class="font-mono whitespace-nowrap">${formatCurrency(eAndLForDisplay)}</span></h4>
                            </div>
                        </div>
                    </div>
                    ${revenueBar}
                </div>`;
            }

            if (state.chapter > 9) {
                 document.getElementById('engine-view').innerHTML = `
                    <main class="flex-1 flex items-center justify-center p-8 bg-slate-50">
                        <div class="text-center max-w-2xl mx-auto">
                            <h2 class="text-3xl md:text-4xl font-bold tracking-tight">This is how money works.</h2>
                            <p class="mt-8 text-base md:text-lg text-slate-500">Thank you for taking this journey through the financial engine.</p>
                            <div class="flex justify-center gap-4 mt-10">
                                <button id="home-btn" class="flex items-center justify-center rounded-md text-sm font-medium h-11 px-8 bg-blue-600 text-white hover:bg-blue-700">
                                    ${ICONS.arrowLeft} Back to Home
                                </button>
                            </div>
                        </div>
                    </main>
                 `;
                 document.getElementById('home-btn').addEventListener('click', () => window.location.reload());
                 return;
            }

            document.getElementById('engine-view').innerHTML = `
                <div class="min-h-screen w-full bg-slate-50 text-slate-800 flex flex-col md:overflow-y-auto md:overflow-x-hidden">
                    <header class="py-4 px-8 md:px-12 flex items-center justify-between shrink-0 bg-white border-b z-20">
                        <button id="header-home" class="text-left"><h1 class="font-bold text-xl">Sanjeev Khanal</h1></button>
                        <div class="flex items-center space-x-2">
                            ${chapters.map((c, i) => `<div class="w-2 h-2 rounded-full transition-all ${state.chapter > i ? 'bg-blue-600' : 'bg-slate-200'}"></div>`).join('')}
                        </div>
                    </header>
                    <main class="flex-1 min-h-0 flex flex-col md:flex-row items-stretch">
                        <div class="order-1 md:order-1 md:w-1/2 flex items-center justify-center bg-slate-100/80 md:border-r" id="visual-pane">
                           ${getMachineVisual()}
                        </div>
                        <div class="order-2 md:order-2 md:w-1/2 p-8 md:p-12 flex flex-col justify-center items-center text-center relative">
                            <div class="w-full max-w-md flex flex-col items-center justify-center">
                                <div id="content-pane" class="flex-grow flex flex-col justify-center items-center w-full">
                                    <h2 class="text-3xl font-bold mb-4">${currentChapter.name}</h2>
                                    ${getChapterContent()}
                                </div>
                                <div id="action-buttons" class="flex items-center justify-between gap-4 w-full max-w-md mt-auto pt-8">
                                   ${getActionButtons()}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            `;

            addEventListeners();

            if (activeElementId) {
                const newActiveElement = document.getElementById(activeElementId);
                if (newActiveElement) {
                    newActiveElement.focus();
                    if (typeof selectionStart !== 'undefined' && (newActiveElement.tagName === 'INPUT' || newActiveElement.tagName === 'TEXTAREA')) {
                        try {
                           newActiveElement.setSelectionRange(selectionStart, selectionEnd);
                        } catch(e) {
                           // Silently ignore errors for input types that don't support selection range
                        }
                    }
                }
            }
        }

        function handleStateChange(updates) {
            Object.assign(state, updates);
            renderEngineView();
        }

        function setChapter(newChapter) {
            state.chapter = newChapter;
            
            // Reset logic
             if (state.chapter === 2) {
                state.equity = 0;
                state.debt = 0;
                if (state.totalCapital === 0) {
                    state.totalCapital = 1000000;
                    state.totalCapitalDisplay = '1000000';
                }
                state.equityPercent = 75;
                state.equityPercentDisplay = '75';
                state.ppe = 0;
                state.workingCapital = 0;
            }
            if (state.chapter === 3) {
                state.ppe = 0;
                state.workingCapital = 0;
            }
            if (state.chapter === 4) {
                 const capital = state.equity + state.debt;
                if (capital > 0 && state.ppe === 0 && state.workingCapital === 0) {
                    const initialPpe = capital * 0.6;
                    state.ppe = initialPpe;
                    state.workingCapital = capital - initialPpe;
                }
            }
            if (state.chapter < 7) {
                state.payments = { cogs: false, opex: false, interest: false, tax: false };
            }
            const capital = state.equity + state.debt;
            const revenue = capital * Number(state.assetTurnover);
            if (state.chapter === 7) {
                state.remainingRevenue = revenue;
                 if (state.opex === '') {
                    state.opex = revenue > 0 ? Math.round(revenue * 0.15) : 150000;
                }
                if (state.interest === '' && state.debt > 0) {
                    state.interest = Math.round(state.debt * 0.1);
                }
            }

            renderEngineView();
        }

        function addEventListeners() {
            document.getElementById('header-home')?.addEventListener('click', () => window.location.reload());
            
            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) prevBtn.addEventListener('click', () => setChapter(Math.max(state.chapter - 1, 1)));
            
            const nextBtn = document.getElementById('next-btn');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const action = nextBtn.dataset.action;
                    if (action === 'inject') {
                        if (state.totalCapital > 0) {
                           handleStateChange({
                               equity: state.totalCapital * (state.equityPercent / 100),
                               debt: state.totalCapital * ((100 - state.equityPercent) / 100),
                           });
                           setChapter(state.chapter + 1);
                        }
                    } else if (state.chapter === 9) {
                        setChapter(10);
                    } else {
                       setChapter(state.chapter + 1);
                    }
                });
            }

            // Chapter-specific listeners
            if (state.chapter === 1) {
                document.getElementById('company-name').addEventListener('input', e => handleStateChange({ companyName: e.target.value }));
            }
            if (state.chapter === 2) {
                document.getElementById('total-capital').addEventListener('input', e => {
                    if (/^\d*$/.test(e.target.value)) {
                        handleStateChange({ totalCapitalDisplay: e.target.value, totalCapital: e.target.value === '' ? 0 : parseInt(e.target.value, 10) });
                    }
                });
                 document.getElementById('equity').addEventListener('input', e => {
                    if (/^\d*$/.test(e.target.value)) {
                        let numValue = e.target.value === '' ? 0 : parseInt(e.target.value, 10);
                        if (numValue > 100) numValue = 100;
                        handleStateChange({ equityPercentDisplay: e.target.value, equityPercent: numValue });
                    }
                });
            }
             if (state.chapter === 4) {
                document.getElementById('ppe-slider').addEventListener('input', e => {
                    const ppe = parseInt(e.target.value, 10);
                    const capital = state.equity + state.debt;
                    handleStateChange({ ppe: ppe, workingCapital: capital - ppe });
                });
            }
             if (state.chapter === 5) {
                document.getElementById('asset-turnover').addEventListener('input', e => {
                    if (e.target.value === '' || /^\d*\.?\d*$/.test(e.target.value)) {
                        handleStateChange({ assetTurnover: e.target.value });
                    }
                });
            }
            if (state.chapter === 7) {
                document.getElementById('cogs-percent').addEventListener('input', e => {
                    if (e.target.value === '' || /^\d*$/.test(e.target.value)) {
                       const num = e.target.value === '' ? 0 : parseInt(e.target.value, 10);
                       if (num >= 0 && num <= 100) handleStateChange({ cogsPercent: num });
                    }
                });
                document.getElementById('tax-percent')?.addEventListener('input', e => {
                    if (e.target.value === '' || /^\d*$/.test(e.target.value)) {
                       const num = e.target.value === '' ? 0 : parseInt(e.target.value, 10);
                       if (num >= 0 && num <= 100) handleStateChange({ taxPercent: num });
                    }
                });
                document.querySelectorAll('[data-cost-input]').forEach(input => {
                    input.addEventListener('input', e => {
                        if (e.target.value === '' || /^\d*\.?\d*$/.test(e.target.value)) {
                           handleStateChange({ [e.target.dataset.costInput]: e.target.value });
                        }
                    });
                });
                document.querySelectorAll('.pay-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const costKey = e.target.dataset.cost;
                        const capital = state.equity + state.debt;
                        const revenue = capital * Number(state.assetTurnover);
                        const cogs = revenue * (Number(state.cogsPercent) / 100);
                        const pbt = revenue - cogs - Number(state.opex) - Number(state.interest);
                        const tax = pbt > 0 ? pbt * (Number(state.taxPercent) / 100) : 0;
                        const costValue = { cogs, opex: Number(state.opex), interest: Number(state.interest), tax }[costKey];
                        
                        const newPayments = { ...state.payments, [costKey]: true };
                        handleStateChange({
                            remainingRevenue: state.remainingRevenue - costValue,
                            payments: newPayments
                        });
                    });
                });
            }
             if (state.chapter === 8) {
                document.getElementById('dividends-percent').addEventListener('input', e => {
                    if (e.target.value === '' || /^\d*$/.test(e.target.value)) {
                       const num = e.target.value === '' ? 0 : parseInt(e.target.value, 10);
                       if (num >= 0 && num <= 100) handleStateChange({ dividendPercent: num });
                    }
                });
            }
        }

        // Initial Render
        render();

    </script>
</body>
</html>
